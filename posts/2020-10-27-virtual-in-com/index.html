<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Virtualization in commercial products | r0da&#39;s Blog</title>
  <meta name="description" content="Hi, I&#39;m r0da and welcome to my blog. Here you can find my posts about my work around reverse engineering and cracking.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Virtualization in commercial products" />
<meta property="og:description" content="Hi all.
Last april, I looked to a commercial software to see how it was protected. It was using Themida 3.0, a very very good virtualization with custom vms, optimized bitcode and stuff.. But after looking around it for one hour, I figured out that some very important parts of the code were not virtualized. In fact, the entier license system were clear x64 !
Today I will try to talk about it without revealing the software for obvious reasons." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://whereisr0da.github.io/blog/posts/2020-10-27-virtual-in-com/" />
<meta property="article:published_time" content="2020-10-27T17:14:00+00:00" />
<meta property="article:modified_time" content="2020-10-27T17:14:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Virtualization in commercial products"/>
<meta name="twitter:description" content="Hi all.
Last april, I looked to a commercial software to see how it was protected. It was using Themida 3.0, a very very good virtualization with custom vms, optimized bitcode and stuff.. But after looking around it for one hour, I figured out that some very important parts of the code were not virtualized. In fact, the entier license system were clear x64 !
Today I will try to talk about it without revealing the software for obvious reasons."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://whereisr0da.github.io/blog/css/style-dark.css">
  <link rel="stylesheet" href="https://whereisr0da.github.io/blog/css/syntax.css" >
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://whereisr0da.github.io/blog/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
    <div class="content index py4">

        <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/blog/">Home</a></li>
         
        <li><a href="/blog/about">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://whereisr0da.github.io/blog/posts/2020-10-21-inject-code/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://whereisr0da.github.io/blog/posts/2020-10-28-poly-pe-lock/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&text=Virtualization%20in%20commercial%20products">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&is_video=false&description=Virtualization%20in%20commercial%20products">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Virtualization%20in%20commercial%20products&body=Check out this article: https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&name=Virtualization%20in%20commercial%20products&description=Hi%20all.%0aLast%20april%2c%20I%20looked%20to%20a%20commercial%20software%20to%20see%20how%20it%20was%20protected.%20It%20was%20using%20Themida%203.0%2c%20a%20very%20very%20good%20virtualization%20with%20custom%20vms%2c%20optimized%20bitcode%20and%20stuff..%20But%20after%20looking%20around%20it%20for%20one%20hour%2c%20I%20figured%20out%20that%20some%20very%20important%20parts%20of%20the%20code%20were%20not%20virtualized.%20In%20fact%2c%20the%20entier%20license%20system%20were%20clear%20x64%20%21%0aToday%20I%20will%20try%20to%20talk%20about%20it%20without%20revealing%20the%20software%20for%20obvious%20reasons.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&t=Virtualization%20in%20commercial%20products">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents"></nav>
    </div>
  </span>
</div>


        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
            <header>
                <h1 class="posttitle" itemprop="name headline">
                     Virtualization in commercial products 
                </h1>
                <div class="meta">
                    
                    <div class="postdate">
                        
                        <time datetime="2020-10-27 17:14:00 &#43;0000 UTC" itemprop="datePublished">2020-10-27</time> 
                    </div>
                     
                </div>
            </header>

            
            <div class="content" itemprop="articleBody">
                <p>Hi all.</p>
<p>Last april, I looked to a commercial software to see how it was protected. It was using Themida 3.0, a very very good virtualization with custom vms, optimized bitcode and stuff.. But after looking around it for one hour, I figured out that some very important parts of the code were not virtualized. In fact, the entier license system were clear x64 !</p>
<p>Today I will try to talk about it without revealing the software for obvious reasons.</p>
<p>So how a good security like Themida could lead to this result ? How this security is applied during the release process ?</p>
<p><img src="https://whereisr0da.github.io/blog/post_images/virtualization_in_com/Themida.png" alt=""></p>
<p>Well in general software that are a little bit serious protect things that should be protected. But, if you look closly, you may notice that there is a problem. Some important parts of the code are not protected at all by the virtualization !!! It&rsquo;s could be resumed by the thing that some software providers wants to apply a security to protect their software without understanding the point of it. They just check security features in the virutalizer menu and click compile. The result : a software that is highly tampored from a first look, but terribly unprotected at the end.</p>
<p>You may think that this software is not that used and didn&rsquo;t face cracks in the past to consider a new security. But it&rsquo;s actualy a software downloaded by over 10 millions of people, made by a big company.</p>
<p>So let&rsquo;s illustrate, and of course, I can&rsquo;t show that much code for obvious reasons.</p>
<p>This is the code section after applying the virtualization :</p>
<p><img src="https://whereisr0da.github.io/blog/post_images/virtualization_in_com/vm.png" alt=""></p>
<p>The virtualized code is in fact a jump to the VM engine with the according opcode. But as you can see, there are lot of remaining code here, and this code is not virtualized. And those code parts are very important, licence check, functions linked to the communications with the server and DRM stuff.</p>
<p>Because all of the license verifications are visible, I can understand the licence system and, by performing a timing attack, I could simply set the licence struct to something valid.</p>
<p>The funny part of this is that the main licence check is not virtualized, but the functions in the vtable that &ldquo;delete&rdquo; the object in memory are !</p>
<p>Something very legit that I could show you :</p>
<p><img src="https://whereisr0da.github.io/blog/post_images/virtualization_in_com/Screenshot_159.png" alt=""></p>
<p>As you can see, the algorith is readable.</p>
<p>But what can lead to this result ? Because some people that are highly skilled in VM said to me that Themida and others like VMP can virtualize the entier executable if they would. So why this result ?</p>
<p>In reality, virtualizers have to consider the code optimization and the ability to find functions without the pdb file. Virtualizing an entier executable could slow down the application in high frequencies procedures. But the most important point is that x86 or x64 executables are terribly locked after the compilation. Everything is melt together and if you add one byte to the code, everything else will crash if you don&rsquo;t do it correctly. Because same instruction in x86 and Themida bytecode has not the same length. The virtualizer as to deal with a lot of problems, and sometimes the solution chosen by Themida is to simply not virtualize.</p>
<p>For exemple, the x86 instruction set has jump instructions that could jump from a current position to another torward. This is called relative jumps and it&rsquo;s easy to handle in a new virtualized language if the next code is also virtualized. But if the code between the jump and the target change its size, the virtualizer has to recalculate the jump offset in order to keep the code flow. Those jumps are handleable, but can became complex very fast.</p>
<p>There are 2 other instructions that are very complex as the relative jump, but maybe not so handleable by the virtualizer. The absolute jump, it&rsquo;s a jump like the previous one, but it&rsquo;s jumping to an absolute address in the executable. It could be anything, anywhere, so in some way, if the main compiler craft an x86 absolute jump from a function to another, the virtualizer has to make a choise. Virtualizing the two functions in hope that the absolute address is keeped, or virtualize one function and not the other, or (like in most of the case where the destination is unidentified) not virtualize at all.</p>
<p><img src="https://whereisr0da.github.io/blog/post_images/virtualization_in_com/indirect.png" alt=""></p>
<p>The last instruction which is the most problematic is absolute indirect jumps. It&rsquo;s a jump, but you jump to an address contained in a register, so it&rsquo;s could be anything. Something calculated, something that change in function of a context &hellip; So during the function parsing process of Themida to get the tree of basic blocks (blocks of code) of a function. It&rsquo;s impossible to get the target basic block (next code executed after the jump) of the jump. You can probably find a way to get it by, calculating it from instructions, it&rsquo;s too complex to get something accurate. Using symbolic execution to get the value in the register at the time, but you have not warranty that your code will be executed, and even if it is, the value could change from an execution to another. In this case, we don&rsquo;t how Themida handle it, but it&rsquo;s certainly not accurate, and the final result should be, to not virtualize.</p>
<p>There are tons of other instructions and circumstances that lead to the same result, but you get the idea, virtualization is not perfect, and virtualazing everything is not a good idea.</p>
<p>But STILL, the developpers have a SDK that could define where the code should be virtualized.</p>
<p>At the end, we can&rsquo;t really define who is at fault here, but the worst could be easily avoided. I know this thread seems very empty, but giving more details equals potential actions against me from the company. So I hope you found this interesting as I do :)</p>
<p>The main thing I want to explain is that using a security need some reflexion regarding the software. And if you don&rsquo;t take that precaution, issues like this could lead to a vulnerability.</p>
<h1 id="r0da">~r0da</h1>

            </div>
        </article>

        
  



 <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/blog/">Home</a></li>
         
          <li><a href="/blog/about">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents"></nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&text=Virtualization%20in%20commercial%20products">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&is_video=false&description=Virtualization%20in%20commercial%20products">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Virtualization%20in%20commercial%20products&body=Check out this article: https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&title=Virtualization%20in%20commercial%20products">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&name=Virtualization%20in%20commercial%20products&description=Hi%20all.%0aLast%20april%2c%20I%20looked%20to%20a%20commercial%20software%20to%20see%20how%20it%20was%20protected.%20It%20was%20using%20Themida%203.0%2c%20a%20very%20very%20good%20virtualization%20with%20custom%20vms%2c%20optimized%20bitcode%20and%20stuff..%20But%20after%20looking%20around%20it%20for%20one%20hour%2c%20I%20figured%20out%20that%20some%20very%20important%20parts%20of%20the%20code%20were%20not%20virtualized.%20In%20fact%2c%20the%20entier%20license%20system%20were%20clear%20x64%20%21%0aToday%20I%20will%20try%20to%20talk%20about%20it%20without%20revealing%20the%20software%20for%20obvious%20reasons.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fwhereisr0da.github.io%2fblog%2fposts%2f2020-10-27-virtual-in-com%2f&t=Virtualization%20in%20commercial%20products">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>
 <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  r0da 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/blog/">Home</a></li>
         
        <li><a href="/blog/about">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


    </div>
</body>

<link rel="stylesheet" href=/blog/lib/font-awesome/css/all.min.css>
<script src=/blog/lib/jquery/jquery.min.js></script>
<script src=/blog/js/main.js></script>
  

</html>